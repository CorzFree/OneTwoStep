{"version":3,"sources":["../../../../../assets/game/script/assets/game/script/player.js"],"names":["GLB","require","cc","Class","extends","Component","properties","heartNodes","Node","helpClip","default","url","AudioClip","jumpDownClip","redAnim","type","Animation","start","clientEvent","on","eventType","gameOver","Game","GameManager","result","heart","hpBarSet","init","playerId","stopTime","curStopTime","playerState","PlayerState","Stand","anim","node","getComponent","jumpPos","jumpRecordId","jumpDurTime","jump","pos","callBack","Jump","Math","abs","x","play","action","moveTo","finished","callFunc","bind","myAction","sequence","runAction","jumpDown","audioEngine","setTimeout","dead","Dead","gameState","GameState","Pause","self","PlayerManager","player","rival","selfScore","length","rivalScore","msg","GAME_OVER_EVENT","sendEventEx","RoadManager","deadSlowdown","Over","reborn","i","active","roadDatas","data","find","temp","ID","offsetX","row","y","offsetY","line","position","Vec2","Play","speedUp","speedUpPercent","console","log","PLAYER_SPEED_UP_EVENT","sendEvent","stopDead","dispatch","update","dt","worldPos","convertToWorldSpaceAR","v2","deadLineWarn","fakeData","isDeadLine","PLAYER_STEP_DATA","shift","x1","y1","p","x2","y2","onDestroy","off"],"mappings":"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","file":"player.js","sourceRoot":"../../../../../assets/game/script","sourcesContent":["var GLB = require(\"Glb\");\ncc.Class({\n    extends: cc.Component,\n    properties: {\n        heartNodes: [cc.Node],\n        helpClip: {\n            default: \"\",\n            url: cc.AudioClip\n        },\n        jumpDownClip: {\n            default: \"\",\n            url: cc.AudioClip\n        },\n\n        redAnim: {\n            default: null,\n            type: cc.Animation\n        }\n    },\n\n    start() {\n        clientEvent.on(clientEvent.eventType.gameOver, this.gameOver, this);\n    },\n\n    gameOver() {\n        if (!Game.GameManager.result) {\n            this.heart = 0;\n            this.hpBarSet();\n        }\n    },\n\n    init: function(playerId) {\n        this.stopTime = 15;\n        this.curStopTime = 0;\n        this.playerId = playerId;\n        this.heart = 3;\n        this.playerState = PlayerState.Stand;\n        this.anim = this.node.getComponent(cc.Animation);\n        this.jumpPos = [];\n        this.jumpRecordId = 1;\n        this.jumpDurTime = 0.5;\n    },\n\n    jump: function(pos, callBack) {\n        this.playerState = PlayerState.Jump;\n        if (Math.abs(this.node.x - pos.x) < 1) {\n            this.anim.play(\"jumpForward\");\n        } else if (this.node.x - pos.x < 0) {\n            this.anim.play(\"jumpRight\");\n        } else {\n            this.anim.play(\"jumpLeft\");\n        }\n\n        var action = cc.moveTo(this.jumpDurTime, pos);\n        var finished = cc.callFunc(function() {\n            this.anim.play(\"stand\");\n            this.playerState = PlayerState.Stand;\n            if (callBack) {\n                callBack();\n            }\n        }.bind(this));\n        var myAction = cc.sequence(action, finished);\n        this.node.runAction(myAction);\n    },\n\n    jumpDown: function(pos) {\n        this.jump(pos, function() {\n            this.anim.play(\"down\");\n            cc.audioEngine.play(this.jumpDownClip, false, 1);\n            setTimeout(function() {\n                cc.audioEngine.play(this.helpClip, false, 1);\n            }.bind(this), 500);\n            this.dead();\n        }.bind(this));\n    },\n\n    dead: function() {\n        this.playerState = PlayerState.Dead;\n        this.heart--;\n        this.hpBarSet();\n        this.redAnim.play();\n        if (this.heart <= 0) {\n            // 游戏结束--\n            Game.GameManager.gameState = GameState.Pause;\n            var self = Game.PlayerManager.player;\n            var rival = Game.PlayerManager.rival;\n            var selfScore = self.jumpRecordId + self.jumpPos.length;\n            var rivalScore = rival.jumpRecordId + rival.jumpPos.length;\n\n            var msg = {\n                action: GLB.GAME_OVER_EVENT,\n                playerId: this.playerId,\n                selfScore: selfScore,\n                rivalScore: rivalScore\n            };\n            Game.GameManager.sendEventEx(msg);\n        } else {\n            Game.GameManager.gameState = GameState.Pause;\n            Game.RoadManager.deadSlowdown();\n            // 进入复活--\n            setTimeout(function() {\n                if (Game.GameManager.gameState !== GameState.Over) {\n                    this.reborn();\n                }\n            }.bind(this), 1000);\n        }\n    },\n\n    hpBarSet() {\n        for (var i = 0; i < this.heartNodes.length; i++) {\n            if (i < this.heart) {\n                this.heartNodes[i].active = true;\n            } else {\n                this.heartNodes[i].active = false;\n            }\n        }\n    },\n\n    reborn: function() {\n        if (Game.RoadManager.roadDatas) {\n            var data = Game.RoadManager.roadDatas.find(function(temp) {\n                return temp.ID === this.jumpRecordId + 1;\n            }.bind(this));\n\n            var x = Game.RoadManager.offsetX * (data.row - 1);\n            var y = Game.RoadManager.offsetY * (data.line - 1);\n            this.node.position = new cc.Vec2(x, y);\n\n            this.playerState = PlayerState.Stand;\n            this.anim.play(\"reborn\");\n\n            setTimeout(function() {\n                if (Game.GameManager.gameState === GameState.Pause) {\n                    Game.GameManager.gameState = GameState.Play;\n                }\n            }, 2000);\n\n            this.jumpPos = [];\n            this.jumpRecordId += 2;\n        }\n    },\n\n    speedUp: function() {\n        this.jumpDurTime /= Game.RoadManager.speedUpPercent;\n        console.log(\"jumpDurTime:\" + this.jumpDurTime);\n        var msg = {\n            action: GLB.PLAYER_SPEED_UP_EVENT\n        };\n        Game.GameManager.sendEvent(msg);\n    },\n\n    stopDead() {\n        this.heart--;\n        this.hpBarSet();\n        if (this.heart <= 0) {\n            Game.GameManager.result = false;\n            clientEvent.dispatch(clientEvent.eventType.gameOver);\n        }\n    },\n\n    update(dt) {\n        if (Game.GameManager.gameState !== GameState.Play) {\n            return;\n        }\n        this.curStopTime += dt;\n        if (this.curStopTime > this.stopTime) {\n            this.curStopTime = 0;\n            this.stopDead();\n        }\n        var worldPos = this.node.convertToWorldSpaceAR(cc.v2(0, 0));\n        if (worldPos.y < 0) {\n            this.curStopTime = 0;\n            Game.RoadManager.deadLineWarn();\n            this.dead();\n            var fakeData = {\n                ID: 0,\n                isDeadLine: true\n            }\n            var msg = {\n                action: GLB.PLAYER_STEP_DATA,\n                data: fakeData\n            };\n            this.anim.play(\"shock\");\n            Game.GameManager.sendEvent(msg);\n        } else if (this.playerState === PlayerState.Stand\n            && this.jumpPos && this.jumpPos.length > 0) {\n            this.curStopTime = 0;\n            var data = this.jumpPos.shift();\n\n            if (this.jumpRecordId === data.ID) {\n                var x1 = Game.RoadManager.offsetX * (data.row - 1);\n                var y1 = Game.RoadManager.offsetY * (data.line - 1);\n                this.jump(cc.p(x1, y1));\n\n                this.jumpRecordId++;\n            } else {\n                var x2 = Game.RoadManager.offsetX * (data.row - 1);\n                var y2 = Game.RoadManager.offsetY * (data.line - 1);\n                this.jumpDown(cc.p(x2, y2));\n            }\n        }\n    },\n\n    onDestroy() {\n        clientEvent.off(clientEvent.eventType.gameOver, this.gameOver, this);\n    }\n});\n"]}